name: Playwright
on:
  - pull_request

jobs:
  playwright:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Create kind config file
        run: |
          cat <<EOF > kind-config.yaml
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
              kubeadmConfigPatches:
              - |
                kind: InitConfiguration
                nodeRegistration:
                  kubeletExtraArgs:
                    node-labels: "ingress-ready=true"
              extraPortMappings:
              - containerPort: 80
                hostPort: 80
                protocol: TCP
              - containerPort: 443
                hostPort: 443
                protocol: TCP
          EOF

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          config: kind-config.yaml

      - name: Install NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=90s

      - name: Install Backstage
        run: |
          helm repo add rhdh-chart https://redhat-developer.github.io/rhdh-chart
          helm install rhdh rhdh-chart/backstage --set global.host=backstage.127.0.0.1.nip.io  --set route.enabled=false --set upstream.ingress.enabled=true

      - name: Wait for Backstage to be ready
        run: |
          kubectl wait --namespace default --for=condition=ready pod --selector=app.kubernetes.io/instance=rhdh --timeout=120s
          curl http://backstage.127.0.0.1.nip.io
